# Configuring Raspberry PI


# The next could be needed when starting the rasp-config tools complains about no language has been set
# They all need to be executed within a root shell e.g. sudo su -
# export LANGUAGE=en_US.UTF-8
# export LANG=en_US.UTF-8
# export LC_ALL=en_US.UTF-8
# locale-gen en_US.UTF-8
# dpkg-reconfigure locales

# Here is the real installation :-)

# Assuming a fresh copy of Raspbian has been installed
sudo apt-get update
sudo apt-get upgrade
# Use the RasPI config tool to enable I2C support
sudo raspi-config

# Here we go
sudo apt-get install bluetooth bluez-utils blueman i2c-tools

hcitool scan

# Take not of the MAC-address and the name
#   00:02:76:C8:24:79   Nokia LD-3W

# Add a rfcomm entry for the GPS device to /etc/bluetooth/rfcomm.conf
# Replacing with the correct MAC and name if needed.

cat << 'EOF' >> /etc/bluetooth/rfcomm.conf
rfcomm0 {
        bind yes;
        device 00:02:76:C8:24:79;
        channel 1;
        comment "Nokia LD-3W";
}
EOF

# Activate I2C modules and configuration
cat << 'EOF' >> /etc/modules
i2c-bcm2708 
i2c-dev
EOF

# Only if not present, so check first!
cat << 'EOF' >> /boot/config.txt
dtparam=i2c1=on
dtparam=i2c_arm=on
EOF

# Connect to the device in order to enter the pincode
bluez-simple-agent hci0 00:02:76:C8:24:79

# Install GPSD daemon and some tools
sudo apt-get install gpsd gpsd-clients

# Start the GPSD daemon
# -b read-only
# -G listen on all interfaces
# -n don't wait for clients to connect (start polling the GPS immediately)
gpsd -b -G -n /dev/rfcomm0

# Check if everything is working properly (Optional)
gpsmon /dev/rfcomm0

# Install nodejs
curl -sLS https://apt.adafruit.com/add | sudo bash
sudo apt-get install node
# Install used modules
npm install node-gpsd onoff keypress i2c socket.io

# Copy all the JavaScript code, configurations files and scripts to the Raspberry PI
scp *js pi@cato
scp *json pi@cato
scp start-* pi@cato
# and add the following line to the crontab -e
@startup ........

# Install dnsmasq
sudo apt-get install dnsmasq

#Configure DNS DHCP
# TODO add configuration

# Install hostapd for Raspberry PI
# TODO decribe steps

# Configure hostapd
# TODO add configuration

# Add the following line to /etc/hostpad/hostapd.conf
cat << 'EOF' >> /etc/hostpad/hostapd.conf
country_code=NL
EOF

cat << 'EOF' >> /etc/modprobe.d/8182cu.conf
# Disable power saving
#options 8192cu rtw_power_mgnt=0 rtw_enusbss=1 rtw_ips_mode=1
options 8192cu rtw_power_mgnt=0 rtw_enusbss=0
EOF


# RPM 299, 5V  => Offstep = 1900
# RPM 301, 12V => Offstep = 565